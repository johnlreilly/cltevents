<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Charlotte Events Discovery</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#A8C7FA',
            onprimary: '#003258',
            primarycontainer: '#004A77',
            onprimarycontainer: '#D3E4FF',
            secondary: '#B8C8DA',
            onsecondary: '#23323F',
            secondarycontainer: '#394857',
            onsecondarycontainer: '#D4E3F6',
            tertiary: '#A8C7FA',
            ontertiary: '#003258',
            tertiarycontainer: '#004A77',
            ontertiarycontainer: '#D3E4FF',
            surface: '#1C1B1F',
            onsurface: '#E6E1E5',
            surfacevariant: '#49454F',
            onsurfacevariant: '#CAC4D0',
            outline: '#938F99',
            outlinevariant: '#49454F',
          }
        }
      }
    }
  </script>
  <style>
    body {
      background-color: #1C1B1F;
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    const EventDiscoveryApp = () => {
      const [selectedCategory, setSelectedCategory] = useState(() => {
        const saved = localStorage.getItem('cltevents-selectedCategory');
        return saved || 'all';
      });
      const [favorites, setFavorites] = useState(() => {
        const saved = localStorage.getItem('cltevents-favorites');
        return saved ? JSON.parse(saved) : [];
      });
      const [hidden, setHidden] = useState(() => {
        const saved = localStorage.getItem('cltevents-hidden');
        return saved ? JSON.parse(saved) : [];
      });
      const today = new Date().toISOString().split('T')[0];
      const [dateRange, setDateRange] = useState({ start: today, end: '' });
      const [priceRange, setPriceRange] = useState({ min: '', max: '' });
      const [showFilters, setShowFilters] = useState(false);
      const [showFilterTray, setShowFilterTray] = useState(false);
      const [showCategoryMenu, setShowCategoryMenu] = useState(false);
      const [showGenreMenu, setShowGenreMenu] = useState(false);
      const [showSourceMenu, setShowSourceMenu] = useState(false);
      const [showSortMenu, setShowSortMenu] = useState(false);
      const [shareEvent, setShareEvent] = useState(null);
      const [loading, setLoading] = useState(false);
      const [apiEvents, setApiEvents] = useState([]);
      const [lastSync, setLastSync] = useState(null);
      const [sortBy, setSortBy] = useState(() => {
        const saved = localStorage.getItem('cltevents-sortBy');
        return saved || 'date';
      });
      const [initialLoad, setInitialLoad] = useState(true);
      const [expandedDescriptions, setExpandedDescriptions] = useState([]);
      const [expandedYouTube, setExpandedYouTube] = useState({});
      const [pausedYouTube, setPausedYouTube] = useState({});
      const [availableGenres, setAvailableGenres] = useState([]);
      const [selectedGenres, setSelectedGenres] = useState(() => {
        const saved = localStorage.getItem('cltevents-selectedGenres');
        return saved ? JSON.parse(saved) : [];
      });
      const [selectedSources, setSelectedSources] = useState(() => {
        const saved = localStorage.getItem('cltevents-selectedSources');
        return saved ? JSON.parse(saved) : [];
      });
      const [excludeKeywords, setExcludeKeywords] = useState([]);
      const [excludeGenres, setExcludeGenres] = useState([]);
      const [preferredVenues, setPreferredVenues] = useState([]);
      const [diveBarVenues, setDiveBarVenues] = useState([]);
      const [specialEventIcons, setSpecialEventIcons] = useState([]);
      const [showClearConfirm, setShowClearConfirm] = useState(false);
      const [showScrollTop, setShowScrollTop] = useState(false);
      const [scrollButtonPosition, setScrollButtonPosition] = useState(() => {
        const saved = localStorage.getItem('cltevents-scroll-button-position');
        if (saved) {
          return JSON.parse(saved);
        }
        // Default to 66% of viewport height
        const defaultY = window.innerHeight * 0.66;
        return { x: 16, y: defaultY };
      });
      const [isDragging, setIsDragging] = useState(false);
      const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
      const [hasDragged, setHasDragged] = useState(false);
      const [stuckDates, setStuckDates] = useState(new Set());

      React.useEffect(() => {
        fetchEvents();

        // Check for event parameter in URL
        const urlParams = new URLSearchParams(window.location.search);
        const eventSlug = urlParams.get('event');
        if (eventSlug) {
          // Wait for events to load, then scroll to the event
          setTimeout(() => {
            const eventElement = document.getElementById(`event-${eventSlug}`);
            if (eventElement) {
              eventElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
              eventElement.classList.add('ring-2', 'ring-primary');
              setTimeout(() => {
                eventElement.classList.remove('ring-2', 'ring-primary');
              }, 3000);
            }
          }, 1000);
        }
      }, []);

      React.useEffect(() => {
        localStorage.setItem('cltevents-favorites', JSON.stringify(favorites));
      }, [favorites]);

      React.useEffect(() => {
        localStorage.setItem('cltevents-hidden', JSON.stringify(hidden));
      }, [hidden]);

      React.useEffect(() => {
        localStorage.setItem('cltevents-selectedGenres', JSON.stringify(selectedGenres));
      }, [selectedGenres]);

      React.useEffect(() => {
        localStorage.setItem('cltevents-selectedSources', JSON.stringify(selectedSources));
      }, [selectedSources]);

      React.useEffect(() => {
        localStorage.setItem('cltevents-sortBy', sortBy);
      }, [sortBy]);

      React.useEffect(() => {
        localStorage.setItem('cltevents-selectedCategory', selectedCategory);
      }, [selectedCategory]);

      React.useEffect(() => {
        const handleScroll = () => {
          setShowScrollTop(window.scrollY > 300);
        };
        window.addEventListener('scroll', handleScroll);
        return () => window.removeEventListener('scroll', handleScroll);
      }, []);

      const scrollToTop = (e) => {
        if (hasDragged) {
          e.preventDefault();
          setHasDragged(false);
          return;
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      const handleDragStart = (e) => {
        const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

        const rect = e.currentTarget.getBoundingClientRect();
        setDragOffset({
          x: clientX - rect.left,
          y: clientY - rect.top
        });
        setIsDragging(true);
        setHasDragged(false);
      };

      const handleDragMove = (e) => {
        if (!isDragging) return;

        setHasDragged(true);

        const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

        const newX = clientX - dragOffset.x;
        const newY = clientY - dragOffset.y;

        setScrollButtonPosition({ x: newX, y: newY });
      };

      const handleDragEnd = () => {
        if (isDragging) {
          setIsDragging(false);
          localStorage.setItem('cltevents-scroll-button-position', JSON.stringify(scrollButtonPosition));
        }
      };

      React.useEffect(() => {
        if (isDragging) {
          window.addEventListener('mousemove', handleDragMove);
          window.addEventListener('mouseup', handleDragEnd);
          window.addEventListener('touchmove', handleDragMove);
          window.addEventListener('touchend', handleDragEnd);

          return () => {
            window.removeEventListener('mousemove', handleDragMove);
            window.removeEventListener('mouseup', handleDragEnd);
            window.removeEventListener('touchmove', handleDragMove);
            window.removeEventListener('touchend', handleDragEnd);
          };
        }
      }, [isDragging, dragOffset, scrollButtonPosition]);

      React.useEffect(() => {
        const checkStuckHeaders = () => {
          const dateHeaders = document.querySelectorAll('[id^="date-"]');
          const newStuckDates = new Set();

          dateHeaders.forEach((header) => {
            const rect = header.getBoundingClientRect();
            // If the header is at the top position (62px from top), it's stuck
            if (rect.top <= 62 && rect.top >= 61) {
              newStuckDates.add(header.id);
            }
          });

          setStuckDates(newStuckDates);
        };

        window.addEventListener('scroll', checkStuckHeaders);
        checkStuckHeaders(); // Initial check

        return () => window.removeEventListener('scroll', checkStuckHeaders);
      }, [sortedEvents]);

      // Load exclude keywords and genres from JSON file
      React.useEffect(() => {
        fetch('/data/excludeKeywords.json')
          .then(res => res.json())
          .then(data => {
            setExcludeKeywords(data.keywords || []);
            setExcludeGenres(data.genres || []);
          })
          .catch(err => console.error('Error loading exclude keywords:', err));
      }, []);

      // Load preferred venues from JSON file
      React.useEffect(() => {
        fetch('/data/preferredVenues.json')
          .then(res => res.json())
          .then(data => {
            setPreferredVenues(data.preferredVenues || []);
            setDiveBarVenues(data.diveBarVenues || []);
          })
          .catch(err => console.error('Error loading preferred venues:', err));
      }, []);

      // Load special event icons from JSON file
      React.useEffect(() => {
        fetch('/data/specialEventIcons.json')
          .then(res => res.json())
          .then(data => {
            setSpecialEventIcons(data.events || []);
          })
          .catch(err => console.error('Error loading special event icons:', err));
      }, []);

      const filterEvents = () => {
        let filtered = apiEvents;

        filtered = filtered.filter(event => {
          const searchText = `${event.name} ${event.description}`.toLowerCase();
          return !excludeKeywords.some(keyword => searchText.includes(keyword.toLowerCase()));
        });

        // Filter out excluded genres
        filtered = filtered.filter(event => {
          if (!event.genres || event.genres.length === 0) return true;
          return !event.genres.some(genre =>
            excludeGenres.some(excluded => genre.toLowerCase() === excluded.toLowerCase())
          );
        });

        if (selectedGenres.length > 0) {
          filtered = filtered.filter(event =>
            event.genres && event.genres.some(genre => selectedGenres.includes(genre))
          );
        }

        if (selectedSources.length > 0) {
          filtered = filtered.filter(event =>
            selectedSources.includes(event.source)
          );
        }

        const now = new Date();
        filtered = filtered.filter(e => {
          const eventDate = new Date(e.date);
          return eventDate >= now || eventDate.toDateString() === now.toDateString();
        });

        if (selectedCategory === 'hidden') {
          filtered = filtered.filter(e => {
            const normalizedName = e.name.replace(/\s*\([^)]*\)/g, '').toLowerCase().trim();
            return hidden.includes(normalizedName);
          });
        } else {
          // Exclude hidden events from all other views
          filtered = filtered.filter(e => {
            const normalizedName = e.name.replace(/\s*\([^)]*\)/g, '').toLowerCase().trim();
            return !hidden.includes(normalizedName);
          });

          if (selectedCategory !== 'all') {
            if (selectedCategory === 'favorites') {
              filtered = filtered.filter(e => favorites.includes(e.id));
            } else if (selectedCategory === 'divebars') {
              filtered = filtered.filter(e =>
                diveBarVenues.some(venue => e.venue.toLowerCase().includes(venue))
              );
            } else {
              filtered = filtered.filter(e => e.type === selectedCategory);
            }
          }
        }

        if (dateRange.start) {
          filtered = filtered.filter(e => e.date >= dateRange.start);
        }
        if (dateRange.end) {
          filtered = filtered.filter(e => e.date <= dateRange.end);
        }

        if (priceRange.min) {
          filtered = filtered.filter(e => e.price >= Number(priceRange.min));
        }
        if (priceRange.max) {
          filtered = filtered.filter(e => e.price <= Number(priceRange.max));
        }

        return filtered;
      };

      const toTitleCase = (str) => {
        // Check if string is all caps (more than 3 consecutive uppercase letters)
        if (/[A-Z]{4,}/.test(str)) {
          return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
        }
        return str;
      };

      const cleanYouTubeTitle = (title) => {
        // Create a temporary element to decode HTML entities
        const textarea = document.createElement('textarea');
        textarea.innerHTML = title;
        let cleaned = textarea.value;

        // Remove common YouTube noise
        cleaned = cleaned
          .replace(/\s*\(Official.*?\)/gi, '') // Remove (Official Video), (Official Audio), etc.
          .replace(/\s*\[Official.*?\]/gi, '') // Remove [Official Video], etc.
          .replace(/\s*-\s*Official.*$/gi, '') // Remove - Official Video at end
          .replace(/\s*\|\s*Official.*$/gi, '') // Remove | Official Video at end
          .replace(/\s+LIVE\s+AT\s+.*$/gi, '') // Remove LIVE AT VENUE
          .replace(/\s+at\s+.*(tavern|bar|venue|club|theater|hall).*$/gi, '!') // Clean venue names at end
          .trim();

        // Apply title case if all caps
        cleaned = toTitleCase(cleaned);

        return cleaned;
      };

      const groupEventsByName = (events) => {
        const grouped = {};

        events.forEach(event => {
          if (!event || !event.name || !event.date) return;

          // Remove text in parentheses and normalize for grouping
          const baseName = event.name.replace(/\s*\([^)]*\)/g, '').toLowerCase().trim();
          const key = baseName;

          if (!grouped[key]) {
            grouped[key] = {
              ...event,
              name: event.name.replace(/\s*\([^)]*\)/g, '').trim(), // Use base name without parentheses
              dates: [{ date: event.date, id: event.id, ticketUrl: event.ticketUrl }]
            };
          } else {
            grouped[key].dates.push({ date: event.date, id: event.id, ticketUrl: event.ticketUrl });
          }
        });

        return Object.values(grouped).map(event => ({
          ...event,
          dates: event.dates.sort((a, b) => new Date(a.date) - new Date(b.date))
        }));
      };

      const sortEvents = (events) => {
        return [...events].sort((a, b) => {
          if (sortBy === 'date') {
            const dateCompare = new Date(a.dates[0].date) - new Date(b.dates[0].date);
            if (dateCompare !== 0) return dateCompare;
            
            const aVenueBoost = preferredVenues.some(v => a.venue.toLowerCase().includes(v)) ? 10 : 0;
            const bVenueBoost = preferredVenues.some(v => b.venue.toLowerCase().includes(v)) ? 10 : 0;
            const aScore = a.matchScore + aVenueBoost;
            const bScore = b.matchScore + bVenueBoost;
            return bScore - aScore;
          } else {
            const aVenueBoost = preferredVenues.some(v => a.venue.toLowerCase().includes(v)) ? 10 : 0;
            const bVenueBoost = preferredVenues.some(v => b.venue.toLowerCase().includes(v)) ? 10 : 0;
            const aScore = a.matchScore + aVenueBoost;
            const bScore = b.matchScore + bVenueBoost;
            return bScore - aScore;
          }
        });
      };

      const filteredEvents = filterEvents();
      const groupedEvents = groupEventsByName(filteredEvents);
      const sortedEvents = sortEvents(groupedEvents);

      const categories = [
        { id: 'all', name: 'All' },
        { id: 'favorites', name: 'Favorites' },
        { id: 'divebars', name: 'Dive Bars' },
        { id: 'music', name: 'Music' },
        { id: 'sports', name: 'Sports' },
        { id: 'food', name: 'Food & Drink' },
        { id: 'hidden', name: 'Hidden' }
      ];

      const toggleFavorite = (eventId) => {
        setFavorites(prev =>
          prev.includes(eventId)
            ? prev.filter(id => id !== eventId)
            : [...prev, eventId]
        );
      };

      const toggleHidden = (event) => {
        const eventKey = event.name.toLowerCase().trim();
        setHidden(prev =>
          prev.includes(eventKey)
            ? prev.filter(key => key !== eventKey)
            : [...prev, eventKey]
        );
      };

      const toggleDescription = (eventId) => {
        setExpandedDescriptions(prev =>
          prev.includes(eventId)
            ? prev.filter(id => id !== eventId)
            : [...prev, eventId]
        );
      };

      const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      };

      const formatTime = (timeStr) => {
        if (!timeStr) return null;
        // timeStr is in format "HH:MM:SS"
        const [hours, minutes] = timeStr.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour % 12 || 12;
        return `${displayHour}:${minutes} ${ampm}`;
      };

      const getSpecialIconForDate = (date, events) => {
        // Get all events for this date
        const eventsOnDate = events.filter(e => e.dates && e.dates.some(d => d.date === date));

        // Check if any event matches special icon keywords
        for (const event of eventsOnDate) {
          for (const specialIcon of specialEventIcons) {
            if (specialIcon.matchKeywords.some(keyword =>
              event.name.toLowerCase().includes(keyword.toLowerCase())
            )) {
              return specialIcon.iconType;
            }
          }
        }
        return 'crown'; // Default crown icon
      };

      const getMatchColor = (score) => {
        if (score >= 85) return 'text-green-600 bg-green-50';
        if (score >= 70) return 'text-blue-600 bg-blue-50';
        return 'text-gray-600 bg-gray-50';
      };

      const isPreferredVenue = (venue) => {
        return preferredVenues.some(v => venue.toLowerCase().includes(v));
      };

      const hasUsefulDescription = (event) => {
        if (!event.description) return false;
        const desc = event.description.trim().toLowerCase();
        // Normalize name by removing parentheses, just like we do when grouping events
        const name = event.name.replace(/\s*\([^)]*\)/g, '').trim().toLowerCase();
        const venue = event.venue.trim().toLowerCase();

        // Hide if description is the same as the normalized event name
        if (desc === name) return false;

        // Hide if description only contains venue information
        if (desc === venue || desc.includes(venue) && desc.length < venue.length + 20) return false;

        return true;
      };

      const handleAddToCalendar = (event) => {
        // Create ICS calendar file
        const eventDate = new Date(event.dates[0].date);
        const eventTime = event.time || '19:00:00'; // Default to 7 PM if no time
        const [hours, minutes] = eventTime.split(':');

        // Set start time
        const startDate = new Date(eventDate);
        startDate.setHours(parseInt(hours), parseInt(minutes), 0);

        // Set end time (2 hours later by default)
        const endDate = new Date(startDate);
        endDate.setHours(startDate.getHours() + 2);

        // Format dates for ICS (YYYYMMDDTHHMMSS)
        const formatICSDate = (date) => {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const hour = String(date.getHours()).padStart(2, '0');
          const min = String(date.getMinutes()).padStart(2, '0');
          const sec = String(date.getSeconds()).padStart(2, '0');
          return `${year}${month}${day}T${hour}${min}${sec}`;
        };

        const description = event.ticketUrl ? `${event.description}\\n\\nTickets: ${event.ticketUrl}` : event.description;
        const location = event.venueAddress ? `${event.venue}, ${event.venueAddress}` : event.venue;

        const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//CLT.show//Event Calendar//EN
BEGIN:VEVENT
UID:${event.id}@clt.show
DTSTAMP:${formatICSDate(new Date())}
DTSTART:${formatICSDate(startDate)}
DTEND:${formatICSDate(endDate)}
SUMMARY:${event.name}
DESCRIPTION:${description}
LOCATION:${location}
URL:${event.ticketUrl || 'https://clt.show'}
END:VEVENT
END:VCALENDAR`;

        // Create download link
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${event.name.replace(/[^a-z0-9]/gi, '-')}.ics`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const handleGetDirections = (event) => {
        const address = event.venueAddress ? `${event.venue}, ${event.venueAddress}` : event.venue;
        const encodedAddress = encodeURIComponent(address);

        // Use Google Maps URL scheme that works on both iOS and Android
        // iOS will redirect to Apple Maps if Google Maps isn't installed
        const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;

        window.open(mapsUrl, '_blank');
      };

      const handleShare = async (event) => {
        // Create a URL-friendly slug from the event name
        const slug = event.name.toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '');

        const eventUrl = `https://clt.show/?event=${slug}`;
        const priceText = event.price && event.price !== 0 && event.price !== '0' && event.price !== 'N/A'
          ? ` Only $${event.price}`
          : '';
        const shareText = `Check out ${event.name} at ${event.venue} on ${formatDate(event.dates[0].date)}!${priceText}\n\n${eventUrl}`;
        const shareTitle = `${event.name} - CLT.show`;

        // Try to use Web Share API first (supports email with subject line)
        if (navigator.share) {
          try {
            await navigator.share({
              title: shareTitle,
              text: shareText,
              url: eventUrl
            });
            setShareEvent(event);
            setTimeout(() => setShareEvent(null), 3000);
            return;
          } catch (err) {
            // User cancelled or share failed, fall back to clipboard
            if (err.name !== 'AbortError') {
              console.log('Share failed:', err);
            }
          }
        }

        // Fallback to clipboard
        navigator.clipboard.writeText(shareText);
        setShareEvent(event);
        setTimeout(() => setShareEvent(null), 3000);
      };

      const clearFilters = () => {
        setDateRange({ start: today, end: '' });
        setPriceRange({ min: '', max: '' });
        setSelectedGenres([]);
        setSelectedSources([]);
      };

      const toggleGenre = (genre) => {
        setSelectedGenres(prev =>
          prev.includes(genre)
            ? prev.filter(g => g !== genre)
            : [...prev, genre]
        );
      };

      const toggleSource = (source) => {
        setSelectedSources(prev =>
          prev.includes(source)
            ? prev.filter(s => s !== source)
            : [...prev, source]
        );
      };

      const fetchEvents = async () => {
        setLoading(true);
        try {
          // Fetch from all sources in parallel
          const [ticketmasterResponse, smokeyJoesResponse, cltTodayResponse] = await Promise.all([
            fetch('/api/events'),
            fetch('/api/smokeyjoes'),
            fetch('/api/clttoday')
          ]);

          let allEvents = [];

          // Process Ticketmaster events
          if (ticketmasterResponse.ok) {
            const tmData = await ticketmasterResponse.json();
            
            const tmEvents = await Promise.all(tmData.events.map(async (tmEvent) => {
              let eventType = 'other';
              const classification = tmEvent.classifications?.[0];
              const segment = classification?.segment?.name?.toLowerCase() || '';
              const genre = classification?.genre?.name?.toLowerCase() || '';
              
              const genres = [];
              if (classification?.segment?.name && classification.segment.name !== 'Undefined') {
                genres.push(classification.segment.name);
              }
              if (classification?.genre?.name && classification.genre.name !== 'Undefined') {
                genres.push(classification.genre.name);
              }
              if (classification?.subGenre?.name && classification.subGenre.name !== 'Undefined') {
                genres.push(classification.subGenre.name);
              }
              
              if (segment.includes('music') || genre.includes('music')) {
                eventType = 'music';
              } else if (segment.includes('sports')) {
                eventType = 'sports';
              } else if (segment.includes('arts') || segment.includes('theatre')) {
                eventType = 'other';
              }

              let price = 0;
              if (tmEvent.priceRanges && tmEvent.priceRanges.length > 0) {
                price = tmEvent.priceRanges[0].min || 0;
              }

              const venueData = tmEvent._embedded?.venues?.[0];
              const venue = venueData?.name || 'Venue TBA';
              const venueAddress = venueData?.address?.line1
                ? `${venueData.address.line1}, ${venueData.city?.name || ''}, ${venueData.state?.stateCode || ''} ${venueData.postalCode || ''}`.trim()
                : '';

              let matchScore = 70;
              if (preferredVenues.some(v => venue.toLowerCase().includes(v))) {
                matchScore += 15;
              }
              if (eventType === 'music') {
                matchScore += 10;
              }

              let youtubeLinks = [];
              if (eventType === 'music') {
                youtubeLinks = await fetchYouTubeVideos(tmEvent.name);
              }

              // Extract image URL - prefer high resolution images
              let imageUrl = null;
              if (tmEvent.images && tmEvent.images.length > 0) {
                // Sort by width descending to get highest resolution
                const sortedImages = [...tmEvent.images].sort((a, b) => (b.width || 0) - (a.width || 0));
                imageUrl = sortedImages[0]?.url;
              }

              return {
                id: `tm-${tmEvent.id}`,
                name: tmEvent.name,
                type: eventType,
                date: tmEvent.dates?.start?.localDate || '',
                time: tmEvent.dates?.start?.localTime || null,
                venue: venue,
                venueAddress: venueAddress,
                distance: 'N/A',
                description: tmEvent.info || tmEvent.pleaseNote || tmEvent.name,
                price: price,
                youtubeLinks: youtubeLinks.length > 0 ? youtubeLinks : undefined,
                matchScore: Math.min(matchScore, 98),
                ticketUrl: tmEvent.url,
                genres: genres,
                imageUrl: imageUrl,
                source: 'ticketmaster'
              };
            }));
            
            allEvents = [...allEvents, ...tmEvents];
          }

          // Process Smokey Joe's events
          if (smokeyJoesResponse.ok) {
            const sjData = await smokeyJoesResponse.json();
            
            const sjEvents = await Promise.all(sjData.events.map(async (sjEvent) => {
              // All Smokey Joe's events are music
              const eventType = 'music';
              
              // Smokey Joe's is a preferred venue, so give it a boost
              let matchScore = 70 + 15 + 10; // base + venue boost + music boost = 95

              let youtubeLinks = await fetchYouTubeVideos(sjEvent.name);
              
              return {
                id: `sj-${sjEvent.name}-${sjEvent.date}`,
                name: sjEvent.name,
                type: eventType,
                date: sjEvent.date,
                time: sjEvent.time || null,
                venue: sjEvent.venue,
                distance: 'N/A',
                description: sjEvent.description,
                price: 0, // Smokey Joe's doesn't provide pricing
                youtubeLinks: youtubeLinks.length > 0 ? youtubeLinks : undefined,
                matchScore: matchScore,
                ticketUrl: 'https://smokeyjoes.cafe',
                genres: ['Music', 'Live'],
                source: 'smokeyjoes'
              };
            }));
            
            allEvents = [...allEvents, ...sjEvents];
          }

          // Process CLTtoday events
          if (cltTodayResponse.ok) {
            const cltData = await cltTodayResponse.json();

            const cltEvents = [];
            cltData.events.forEach((cltEvent) => {
              // Base match score for CLTtoday articles (lower since they're not direct event listings)
              let matchScore = 60;

              // Boost if it's in the Events category
              if (cltEvent.category?.toLowerCase().includes('event')) {
                matchScore += 10;
              }

              // If article has event dates, create an event for the earliest upcoming date
              if (cltEvent.eventDates && cltEvent.eventDates.length > 0) {
                // Sort dates and find the first future date
                const sortedDates = cltEvent.eventDates.sort();
                const today = new Date().toISOString().split('T')[0];
                const upcomingDate = sortedDates.find(date => date >= today) || sortedDates[0];

                // Use section headers as genres, fallback to category or 'News'
                const genres = cltEvent.sectionHeaders && cltEvent.sectionHeaders.length > 0
                  ? cltEvent.sectionHeaders
                  : (cltEvent.category ? [cltEvent.category] : ['News']);

                cltEvents.push({
                  id: `clt-${cltEvent.url}`,
                  name: cltEvent.name,
                  type: 'article',
                  date: upcomingDate,
                  time: null,
                  venue: 'CLTtoday Article',
                  venueAddress: '',
                  distance: 'N/A',
                  description: cltEvent.description || cltEvent.name,
                  price: 0,
                  matchScore: matchScore,
                  ticketUrl: cltEvent.url,
                  genres: genres,
                  imageUrl: cltEvent.image,
                  source: 'clttoday',
                  dates: [{ date: upcomingDate, id: `clt-${cltEvent.url}`, ticketUrl: cltEvent.url }]
                });
              }
            });

            allEvents = [...allEvents, ...cltEvents];
          }

          setApiEvents(allEvents);

          // Extract unique genres for filtering, excluding the ones we filter out
          const allGenres = new Set();
          allEvents.forEach(event => {
            if (event.genres) {
              event.genres.forEach(genre => {
                // Only add genre if it's not in the excluded list
                if (!excludeGenres.some(excluded => genre.toLowerCase().includes(excluded.toLowerCase()))) {
                  allGenres.add(genre);
                }
              });
            }
          });
          setAvailableGenres(Array.from(allGenres).sort());

          setLastSync(new Date());
          setInitialLoad(false);
          if (!initialLoad) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            alert(`Successfully loaded ${allEvents.length} events from Ticketmaster, Smokey Joe's, and CLTtoday!`);
          }
        } catch (error) {
          setInitialLoad(false);
          alert(`Error fetching events: ${error.message}`);
          console.error('API Error:', error);
        } finally {
          setLoading(false);
        }
      };

      // YouTube cache to prevent redundant API calls
      // Load from localStorage on mount
      const getInitialYouTubeCache = () => {
        try {
          const saved = localStorage.getItem('cltevents-youtube-cache');
          return saved ? JSON.parse(saved) : {};
        } catch (error) {
          console.error('Error loading YouTube cache:', error);
          return {};
        }
      };
      const youtubeCache = React.useRef(getInitialYouTubeCache());

      const fetchYouTubeVideos = async (artistName) => {
        // Check cache first
        const cacheKey = artistName.toLowerCase().trim();
        if (youtubeCache.current[cacheKey]) {
          console.log('Using cached YouTube results for', artistName);
          return youtubeCache.current[cacheKey];
        }

        try {
          const response = await fetch(`/api/youtube?query=${encodeURIComponent(artistName)}`);

          if (!response.ok) {
            const errorData = await response.json();
            console.error('YouTube API error:', response.status, errorData);
            // Cache empty results to avoid retrying failed searches
            youtubeCache.current[cacheKey] = [];
            return [];
          }

          const data = await response.json();
          console.log('YouTube API call for', artistName, ':', data.videos?.length || 0, 'videos');

          // Cache the results
          youtubeCache.current[cacheKey] = data.videos || [];

          // Save cache to localStorage
          try {
            localStorage.setItem('cltevents-youtube-cache', JSON.stringify(youtubeCache.current));
          } catch (e) {
            console.error('Error saving YouTube cache:', e);
          }

          return data.videos || [];
        } catch (error) {
          console.error('Error fetching YouTube videos for', artistName, ':', error);
          // Cache empty results to avoid retrying failed searches
          youtubeCache.current[cacheKey] = [];

          // Save cache to localStorage
          try {
            localStorage.setItem('cltevents-youtube-cache', JSON.stringify(youtubeCache.current));
          } catch (e) {
            console.error('Error saving YouTube cache:', e);
          }

          return [];
        }
      };

      const hasActiveFilters = (dateRange.start && dateRange.start !== today) || dateRange.end || priceRange.min || priceRange.max || selectedGenres.length > 0 || selectedSources.length > 0;

      return (
        <div className="min-h-screen bg-black">
          {/* Material 3 Top App Bar */}
          <div className="bg-surface shadow-sm sticky top-0 z-30 border-b border-outlinevariant">
            <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
              <h1 className="text-xl font-semibold text-onsurface">CLT.show</h1>
              <div className="flex items-center gap-2">
                <button
                  onClick={() => {
                    setShowFilterTray(!showFilterTray);
                    if (!showFilterTray) {
                      window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                  }}
                  className={`p-2 rounded-full transition-colors relative ${showFilterTray ? 'bg-primarycontainer' : 'hover:bg-primarycontainer'}`}
                  title="Toggle filters"
                >
                  <svg className="w-6 h-6 text-onsurfacevariant" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                  </svg>
                  {hasActiveFilters && !showFilterTray && (
                    <span className="absolute top-1 right-1 w-2 h-2 bg-primary rounded-full"></span>
                  )}
                </button>
                <button
                  onClick={fetchEvents}
                  disabled={loading}
                  className="p-2 rounded-full hover:bg-primarycontainer transition-colors disabled:opacity-50"
                  title="Refresh events"
                >
                  <svg className="w-6 h-6 text-onsurfacevariant" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div className="max-w-6xl mx-auto px-4 sm:px-6 py-6">

            {/* Filter Tray */}
            {showFilterTray && (
              <div className="mb-6 p-6 bg-surface rounded-3xl border border-outlinevariant">
                {/* Header */}
                <h2 className="text-lg font-semibold text-onsurface mb-6">Filter & Sort</h2>

                {/* Filter and Sort Controls */}
                <div className="space-y-3">
                  <div className="relative">
                <button
                  onClick={() => setShowCategoryMenu(!showCategoryMenu)}
                  className="flex items-center gap-2 px-6 py-3 bg-secondarycontainer text-onsecondarycontainer rounded-full hover:shadow-md transition-all w-full font-medium"
                >
                  <span>{categories.find(cat => cat.id === selectedCategory)?.name || 'All Categories'}</span>
                  <svg className="w-5 h-5 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                  </svg>
                </button>

                {showCategoryMenu && (
                  <>
                    <div
                      className="fixed inset-0 bg-black bg-opacity-30 z-40"
                      onClick={() => setShowCategoryMenu(false)}
                    />
                    <div className="absolute top-full left-0 mt-2 w-full bg-surface rounded-2xl shadow-2xl z-50 overflow-hidden border border-outlinevariant">
                      {categories.map(cat => (
                        <button
                          key={cat.id}
                          onClick={() => {
                            setSelectedCategory(cat.id);
                            setShowCategoryMenu(false);
                          }}
                          className={`flex items-center gap-3 px-6 py-4 w-full text-left transition-all ${
                            selectedCategory === cat.id
                              ? 'bg-primarycontainer text-onprimarycontainer'
                              : cat.id === 'hidden'
                              ? 'text-onsurfacevariant hover:bg-surfacevariant'
                              : 'text-onsurface hover:bg-surfacevariant'
                          }`}
                        >
                          <span className="font-medium">{cat.name}</span>
                          {selectedCategory === cat.id && (
                            <svg className="w-5 h-5 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                            </svg>
                          )}
                        </button>
                      ))}
                    </div>
                  </>
                )}
              </div>

              <div className="relative">
                <button
                  onClick={() => setShowGenreMenu(!showGenreMenu)}
                  className="flex items-center gap-2 px-6 py-3 bg-secondarycontainer text-onsecondarycontainer rounded-full hover:shadow-md transition-all w-full font-medium"
                >
                  <span>{selectedGenres.length === 0 ? 'All Genres' : `${selectedGenres.length} Genre${selectedGenres.length > 1 ? 's' : ''}`}</span>
                  <svg className="w-5 h-5 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                  </svg>
                </button>

                {showGenreMenu && (
                  <>
                    <div
                      className="fixed inset-0 bg-black bg-opacity-30 z-40"
                      onClick={() => setShowGenreMenu(false)}
                    />
                    <div className="absolute top-full left-0 mt-2 w-full bg-surface rounded-2xl shadow-2xl z-50 max-h-96 overflow-y-auto border border-outlinevariant">
                      {selectedGenres.length > 0 && (
                        <button
                          onClick={() => setSelectedGenres([])}
                          className="flex items-center gap-3 px-6 py-3 w-full text-left border-b border-outlinevariant text-primary hover:bg-primarycontainer font-medium"
                        >
                          Clear All
                        </button>
                      )}
                      {availableGenres.map(genre => (
                        <button
                          key={genre}
                          onClick={() => {
                            setSelectedGenres(prev =>
                              prev.includes(genre)
                                ? prev.filter(g => g !== genre)
                                : [...prev, genre]
                            );
                          }}
                          className="flex items-center gap-3 px-6 py-3 w-full text-left transition-all text-onsurface hover:bg-surfacevariant"
                        >
                          <div className={`w-5 h-5 rounded border-2 flex items-center justify-center ${
                            selectedGenres.includes(genre)
                              ? 'bg-primary border-primary'
                              : 'border-outline'
                          }`}>
                            {selectedGenres.includes(genre) && (
                              <svg className="w-3 h-3 text-onprimary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                              </svg>
                            )}
                          </div>
                          <span className="font-medium">{genre}</span>
                        </button>
                      ))}
                    </div>
                  </>
                )}
              </div>

              {/* Source Dropdown */}
              <div className="relative">
                <button
                  onClick={() => setShowSourceMenu(!showSourceMenu)}
                  className="flex items-center gap-2 px-6 py-3 bg-secondarycontainer text-onsecondarycontainer rounded-full hover:shadow-md transition-all w-full font-medium"
                >
                  <span>{selectedSources.length === 0 ? 'All Sources' : `${selectedSources.length} Source${selectedSources.length > 1 ? 's' : ''}`}</span>
                  <svg className="w-5 h-5 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                  </svg>
                </button>

                {showSourceMenu && (
                  <>
                    <div
                      className="fixed inset-0 bg-black bg-opacity-30 z-40"
                      onClick={() => setShowSourceMenu(false)}
                    />
                    <div className="absolute top-full left-0 mt-2 w-full bg-surface rounded-2xl shadow-2xl z-50 max-h-96 overflow-y-auto border border-outlinevariant">
                      {selectedSources.length > 0 && (
                        <button
                          onClick={() => setSelectedSources([])}
                          className="flex items-center gap-3 px-6 py-3 w-full text-left border-b border-outlinevariant text-primary hover:bg-primarycontainer font-medium"
                        >
                          Clear All
                        </button>
                      )}
                      {['ticketmaster', 'smokeyjoes', 'clttoday'].map(source => (
                        <button
                          key={source}
                          onClick={() => {
                            toggleSource(source);
                          }}
                          className="flex items-center gap-3 px-6 py-3 w-full text-left transition-all text-onsurface hover:bg-surfacevariant"
                        >
                          <div className={`w-5 h-5 rounded border-2 flex items-center justify-center ${
                            selectedSources.includes(source)
                              ? 'bg-primary border-primary'
                              : 'border-outline'
                          }`}>
                            {selectedSources.includes(source) && (
                              <svg className="w-3 h-3 text-onprimary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                              </svg>
                            )}
                          </div>
                          <span className="font-medium capitalize">{source === 'smokeyjoes' ? "Smokey Joe's" : source === 'clttoday' ? 'CLTtoday' : 'Ticketmaster'}</span>
                        </button>
                      ))}
                    </div>
                  </>
                )}
              </div>

              {/* Sort Dropdown */}
              <div className="relative">
                <button
                  onClick={() => setShowSortMenu(!showSortMenu)}
                  className="flex items-center gap-2 px-6 py-3 bg-secondarycontainer text-onsecondarycontainer rounded-full hover:shadow-md transition-all w-full font-medium"
                >
                  <span>Sort: {sortBy === 'date' ? 'Date' : 'Best Match'}</span>
                  <svg className="w-5 h-5 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                  </svg>
                </button>

                {showSortMenu && (
                  <>
                    <div
                      className="fixed inset-0 bg-black bg-opacity-30 z-40"
                      onClick={() => setShowSortMenu(false)}
                    />
                    <div className="absolute top-full left-0 mt-2 w-full bg-surface rounded-2xl shadow-2xl z-50 overflow-hidden border border-outlinevariant">
                      <button
                        onClick={() => {
                          setSortBy('date');
                          setShowSortMenu(false);
                        }}
                        className={`flex items-center gap-3 px-6 py-4 w-full text-left transition-all ${
                          sortBy === 'date'
                            ? 'bg-primarycontainer text-onprimarycontainer'
                            : 'text-onsurface hover:bg-surfacevariant'
                        }`}
                      >
                        <span className="font-medium">Date</span>
                        {sortBy === 'date' && (
                          <svg className="w-5 h-5 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        )}
                      </button>
                      <button
                        onClick={() => {
                          setSortBy('match');
                          setShowSortMenu(false);
                        }}
                        className={`flex items-center gap-3 px-6 py-4 w-full text-left transition-all ${
                          sortBy === 'match'
                            ? 'bg-primarycontainer text-onprimarycontainer'
                            : 'text-onsurface hover:bg-surfacevariant'
                        }`}
                      >
                        <span className="font-medium">Best Match</span>
                        {sortBy === 'match' && (
                          <svg className="w-5 h-5 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        )}
                      </button>
                    </div>
                  </>
                )}
              </div>

              {/* Close Button */}
              <button
                onClick={() => setShowFilterTray(false)}
                className="w-full px-6 py-3 bg-[#1E3A5F] text-white rounded-full hover:shadow-md transition-all font-medium"
              >
                Close
              </button>

              {/* Clear Filters Button */}
              {hasActiveFilters && (
                <button
                  onClick={() => setShowClearConfirm(true)}
                  className="w-full px-6 py-3 bg-primary text-onprimary rounded-full hover:shadow-md transition-all font-medium"
                >
                  Clear All Filters
                </button>
              )}
                </div>
              </div>
            )}

            {/* Clear Filters Confirmation Modal */}
            {showClearConfirm && (
              <>
                <div
                  className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
                  onClick={() => setShowClearConfirm(false)}
                >
                  <div
                    className="bg-surface rounded-3xl p-6 max-w-sm mx-4 border border-outlinevariant"
                    onClick={(e) => e.stopPropagation()}
                  >
                    <h3 className="text-lg font-semibold text-onsurface mb-3">Clear All Filters?</h3>
                    <p className="text-sm text-onsurfacevariant mb-6">
                      This will reset all your filter selections including genres and sources.
                    </p>
                    <div className="flex gap-3">
                      <button
                        onClick={() => setShowClearConfirm(false)}
                        className="flex-1 px-6 py-3 bg-surfacevariant text-onsurface rounded-full hover:shadow-md transition-all font-medium"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={() => {
                          clearFilters();
                          setShowClearConfirm(false);
                        }}
                        className="flex-1 px-6 py-3 bg-primary text-onprimary rounded-full hover:shadow-md transition-all font-medium"
                      >
                        Clear All
                      </button>
                    </div>
                  </div>
                </div>
              </>
            )}

              {/* Advanced Filters - Commented Out */}
              {/* {showFilters && (
                <div className="mt-6 pt-6 border-t border-outline">
                  <div className="grid md:grid-cols-2 gap-6">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Date Range</label>
                      <div className="flex gap-2">
                        <input
                          type="date"
                          value={dateRange.start}
                          onChange={(e) => setDateRange({...dateRange, start: e.target.value})}
                          className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        />
                        <span className="flex items-center text-gray-500">to</span>
                        <input
                          type="date"
                          value={dateRange.end}
                          onChange={(e) => setDateRange({...dateRange, end: e.target.value})}
                          className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        />
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Price Range ($)</label>
                      <div className="flex gap-2">
                        <input
                          type="number"
                          placeholder="Min"
                          value={priceRange.min}
                          onChange={(e) => setPriceRange({...priceRange, min: e.target.value})}
                          className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        />
                        <span className="flex items-center text-gray-500">to</span>
                        <input
                          type="number"
                          placeholder="Max"
                          value={priceRange.max}
                          onChange={(e) => setPriceRange({...priceRange, max: e.target.value})}
                          className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        />
                      </div>
                    </div>
                  </div>

                  {availableGenres.length > 0 && (
                    <div className="mt-6">
                      <label className="block text-sm font-semibold text-gray-700 mb-2">
                        Filter by Genre/Type ({selectedGenres.length} selected)
                      </label>
                      <div className="flex flex-wrap gap-2 max-h-60 overflow-y-auto p-2 bg-gray-50 rounded-lg">
                        {availableGenres.map(genre => (
                          <button
                            key={genre}
                            onClick={() => toggleGenre(genre)}
                            className={`px-3 py-1 rounded-full text-sm transition-all ${
                              selectedGenres.includes(genre)
                                ? 'bg-purple-600 text-white'
                                : 'bg-white text-gray-700 border border-gray-300 hover:border-purple-400'
                            }`}
                          >
                            {genre}
                          </button>
                        ))}
                      </div>
                    </div>
                  )}

                  {hasActiveFilters && (
                    <button
                      onClick={clearFilters}
                      className="mt-4 flex items-center gap-2 text-sm text-purple-600 hover:text-purple-700"
                    >
                      Clear All Filters
                    </button>
                  )}
                </div>
              )} */}
            )}

            {initialLoad && loading ? (
              <div className="flex items-center justify-center py-24">
                <div className="text-center">
                  <div className="mb-4">
                    <svg className="animate-spin h-16 w-16 text-primary mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                  </div>
                  <h2 className="text-2xl font-bold text-onsurface mb-2">Stand by... pulling events...</h2>
                  <p className="text-onsurfacevariant">Loading events from the webs!</p>
                </div>
              </div>
            ) : (
              <>
                <div className="mb-4 text-sm text-gray-400 text-center">
                  Charlotte shows... all in one place!
                </div>

                {/* Material 3 Event Cards */}
                <div className="grid md:grid-cols-2 gap-6">
                  {sortedEvents.map((event, index) => {
                    const eventSlug = event.name.toLowerCase()
                      .replace(/[^a-z0-9]+/g, '-')
                      .replace(/^-+|-+$/g, '');

                    // Check if date changed from previous event
                    const currentDate = event.dates[0].date;
                    const previousDate = index > 0 ? sortedEvents[index - 1].dates[0].date : null;
                    const showDateSeparator = currentDate !== previousDate;

                    const formatDateSeparator = (dateStr) => {
                      const date = new Date(dateStr);
                      const year = date.getFullYear();
                      const monthDay = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                      const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' });
                      return { year, monthDay, dayOfWeek };
                    };

                    const dateId = `date-${currentDate}`;
                    const isStuck = stuckDates.has(dateId);

                    return (
                      <React.Fragment key={event.id}>
                        {showDateSeparator && (
                          <div
                            id={dateId}
                            className={`md:col-span-2 bg-[#1E3A5F] rounded-b-3xl h-16 flex flex-col justify-center items-start text-white sticky top-[62px] z-20 overflow-hidden relative ${
                              isStuck ? 'px-4' : 'p-4 rounded-t-3xl'
                            }`}
                          >
                            {/* Crown icon watermark */}
                            <svg className="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 opacity-20" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5m14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z"/>
                            </svg>
                            <div className="text-xl font-semibold">
                              {formatDateSeparator(currentDate).monthDay}, {formatDateSeparator(currentDate).dayOfWeek}
                            </div>
                          </div>
                        )}
                        <div id={`event-${eventSlug}`} className="bg-surface rounded-3xl border border-outlinevariant overflow-hidden hover:shadow-lg transition-all">
                  {event.imageUrl && (
                    <div className="bg-black h-[20vh]" style={{width: '100%', minWidth: '100%', maxWidth: '100%'}}>
                      <img
                        src={event.imageUrl}
                        alt={event.name}
                        style={{width: '100%', height: '100%', objectFit: 'cover', display: 'block', minWidth: '100%', maxWidth: '100%'}}
                        onLoad={(e) => {
                          e.target.style.width = '100%';
                          e.target.style.minWidth = '100%';
                          e.target.style.maxWidth = '100%';
                        }}
                      />
                    </div>
                  )}
                  <div className="p-5">
                    <div className="mb-3">
                      <h3 className="text-xl font-semibold text-onsurface mb-1">{toTitleCase(event.name)}</h3>
                      <p className="text-sm text-onsurfacevariant">{event.venue}</p>
                    </div>

                    <div className="flex items-center gap-4 mb-3 text-sm text-onsurfacevariant">
                      <span className="flex items-center gap-1">
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        {event.dates.length > 1 ? `${event.dates.length} dates` : formatDate(event.dates[0].date)}
                      </span>
                      {event.time && formatTime(event.time) && (
                        <span className="flex items-center gap-1">
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          {formatTime(event.time)}
                        </span>
                      )}
                    </div>

                    {event.dates.length > 1 && (
                      <div className="mb-4 p-3 bg-primarycontainer rounded-lg">
                        <div className="text-sm font-semibold text-onprimarycontainer mb-2">Available Dates:</div>
                        <div className="space-y-1">
                          {event.dates.map((dateInfo, idx) => (
                            <div key={idx} className="flex items-center justify-between text-sm">
                              <span className="text-onprimarycontainer">{formatDate(dateInfo.date)}</span>
                              {dateInfo.ticketUrl && (
                                <a
                                  href={dateInfo.ticketUrl}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="text-primary hover:text-onprimarycontainer text-xs underline"
                                >
                                  Tickets
                                </a>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {event.genres && event.genres.length > 0 && (
                      <div className="mb-4 flex flex-wrap gap-2 items-center">
                        {/* <span className={`px-3 py-1 rounded-full text-xs font-medium ${getMatchColor(event.matchScore)}`}>
                          {event.matchScore}% Match
                        </span> */}
                        {event.genres.map((genre, idx) => (
                          <span key={idx} className="text-xs bg-secondarycontainer text-onsecondarycontainer px-3 py-1 rounded-full font-medium">
                            {genre}
                          </span>
                        ))}
                        {event.source === 'clttoday' && (
                          <svg className="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5m14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z"/>
                          </svg>
                        )}
                      </div>
                    )}

                    {event.genres && event.genres.length > 0 && !expandedYouTube[eventSlug] && (
                      <div className="my-3 border-t border-outlinevariant"></div>
                    )}

                    {event.youtubeLinks && event.youtubeLinks.length > 0 && (
                      <div className="mb-4 p-3 bg-tertiarycontainer rounded-lg">
                        {!expandedYouTube[eventSlug] && (
                          <div className="flex items-center gap-2 mb-2 text-sm font-semibold text-ontertiarycontainer">
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                            </svg>
                            Listen on YouTube
                          </div>
                        )}

                        {/* Single YouTube Player */}
                        {expandedYouTube[eventSlug] && !pausedYouTube[eventSlug] && (() => {
                          const currentVideoIndex = typeof expandedYouTube[eventSlug] === 'number' ? expandedYouTube[eventSlug] : 0;
                          const currentVideo = event.youtubeLinks[currentVideoIndex];

                          // Extract video ID more robustly
                          let videoId = null;
                          if (currentVideo.url.includes('v=')) {
                            videoId = currentVideo.url.split('v=')[1]?.split('&')[0];
                          } else if (currentVideo.url.includes('youtu.be/')) {
                            videoId = currentVideo.url.split('youtu.be/')[1]?.split('?')[0];
                          }

                          const cleanedTitle = cleanYouTubeTitle(currentVideo.title);

                          if (!videoId || videoId.length < 5) {
                            return (
                              <div className="mb-3 p-4 bg-surfacevariant rounded-lg text-center text-onsurfacevariant">
                                This video is not available.
                              </div>
                            );
                          }

                          return (
                            <div className="mb-3">
                              <div className="rounded-lg overflow-hidden" style={{position: 'relative', paddingBottom: '56.25%', height: 0}}>
                                <iframe
                                  style={{position: 'absolute', top: 0, left: 0, width: '100%', height: '100%'}}
                                  src={`https://www.youtube.com/embed/${videoId}?autoplay=1`}
                                  title={cleanedTitle}
                                  frameBorder="0"
                                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                  allowFullScreen
                                />
                              </div>
                            </div>
                          );
                        })()}

                        {/* Video List - Limited to 5 */}
                        <div className="space-y-1 mb-3">
                          {event.youtubeLinks.slice(0, 5).map((link, idx) => {
                            const cleanedTitle = cleanYouTubeTitle(link.title);
                            const currentVideoIndex = typeof expandedYouTube[eventSlug] === 'number' ? expandedYouTube[eventSlug] : 0;
                            const isCurrentVideo = expandedYouTube[eventSlug] && currentVideoIndex === idx;
                            const isPaused = pausedYouTube[eventSlug];

                            return (
                              <button
                                key={idx}
                                onClick={() => {
                                  if (isCurrentVideo) {
                                    // Toggle pause state for current video
                                    setPausedYouTube(prev => ({
                                      ...prev,
                                      [eventSlug]: !prev[eventSlug]
                                    }));
                                  } else {
                                    // Close all other players, then switch to new video
                                    setExpandedYouTube({[eventSlug]: idx});
                                    setPausedYouTube({[eventSlug]: false});
                                  }
                                }}
                                className={`flex items-center gap-2 text-sm w-full text-left px-2 py-1 rounded transition-colors ${
                                  isCurrentVideo
                                    ? 'bg-tertiary text-ontertiary font-semibold'
                                    : 'text-tertiary hover:text-ontertiarycontainer hover:bg-surfacevariant'
                                }`}
                              >
                                <svg className="w-3 h-3 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                  <path d={isCurrentVideo && !isPaused ? "M6 4h4v16H6V4zm8 0h4v16h-4V4z" : "M8 5v14l11-7z"} />
                                </svg>
                                {cleanedTitle}
                              </button>
                            );
                          })}
                        </div>

                        {/* Close Button */}
                        {expandedYouTube[eventSlug] && (
                          <button
                            onClick={() => {
                              setExpandedYouTube(prev => {
                                const newState = {...prev};
                                delete newState[eventSlug];
                                return newState;
                              });
                              setPausedYouTube(prev => {
                                const newState = {...prev};
                                delete newState[eventSlug];
                                return newState;
                              });
                            }}
                            className="w-full px-4 py-2 bg-surfacevariant text-onsurface rounded-lg hover:shadow-md transition-all text-sm font-medium"
                          >
                            Close YouTube
                          </button>
                        )}
                      </div>
                    )}

                    <div className="flex items-center justify-between gap-0">
                      <div className="flex items-center gap-0 -ml-2.5">
                        <button
                          onClick={() => toggleFavorite(event.id)}
                          title="Favorite"
                          className="p-2.5 rounded-full hover:bg-surfacevariant transition-colors"
                        >
                          <svg
                            className={`w-5 h-5 ${favorites.includes(event.id) ? 'fill-tertiary text-tertiary' : 'text-onsurfacevariant'}`}
                            fill={favorites.includes(event.id) ? 'currentColor' : 'none'}
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                          </svg>
                        </button>
                        <button
                          onClick={() => handleAddToCalendar(event)}
                          title="Add to calendar"
                          className="p-2.5 rounded-full hover:bg-surfacevariant transition-colors"
                        >
                          <svg
                            className="w-5 h-5 text-onsurfacevariant"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                          </svg>
                        </button>
                        <button
                          onClick={() => toggleHidden(event)}
                          title="Hide event"
                          className="p-2.5 rounded-full hover:bg-surfacevariant transition-colors"
                        >
                          <svg
                            className={`w-5 h-5 ${hidden.includes(event.name.toLowerCase().trim()) ? 'text-tertiary' : 'text-onsurfacevariant'}`}
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                        <button
                          onClick={() => handleShare(event)}
                          className="p-2.5 rounded-full hover:bg-surfacevariant transition-colors"
                          title="Share event"
                        >
                          <svg className="w-5 h-5 text-onsurfacevariant" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                          </svg>
                        </button>
                        <button
                          onClick={() => handleGetDirections(event)}
                          className="p-2.5 rounded-full hover:bg-surfacevariant transition-colors"
                          title="Get directions"
                        >
                          <svg className="w-5 h-5 text-onsurfacevariant" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                          </svg>
                        </button>
                      </div>
                      {event.ticketUrl ? (
                        <a
                          href={event.ticketUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="px-6 py-1.5 bg-primary text-onprimary rounded-full hover:shadow-md transition-all flex items-center justify-center font-medium text-xs"
                        >
                          Get Tickets
                        </a>
                      ) : event.dates.length === 1 && event.dates[0].ticketUrl ? (
                        <a
                          href={event.dates[0].ticketUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="px-6 py-1.5 bg-primary text-onprimary rounded-full hover:shadow-md transition-all flex items-center justify-center font-medium text-xs"
                        >
                          Get Tickets
                        </a>
                      ) : (
                        <button className="px-6 py-1.5 bg-primary text-onprimary rounded-full hover:shadow-md transition-all flex items-center justify-center font-medium text-xs">
                          Get Tickets
                        </button>
                      )}
                    </div>

                    {hasUsefulDescription(event) && (
                      <button
                        onClick={() => toggleDescription(event.id)}
                        className="text-sm text-primary hover:text-onprimarycontainer font-medium mt-4 block"
                      >
                        {expandedDescriptions.includes(event.id) ? ' Hide Description' : ' Show Description'}
                      </button>
                    )}

                    {hasUsefulDescription(event) && expandedDescriptions.includes(event.id) && (
                      <p className="text-onsurface mt-4">{event.description}</p>
                    )}
                  </div>
                </div>
                      </React.Fragment>
                    );
                  })}
                </div>

                {sortedEvents.length === 0 && (
                  <div className="text-center py-12">
                    <p className="text-gray-500 text-lg">No events found matching your filters.</p>
                    {hasActiveFilters && (
                      <button
                        onClick={clearFilters}
                        className="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                      >
                        Clear Filters
                      </button>
                    )}
                  </div>
                )}
              </>
            )}
          </div>

          {shareEvent && (
            <div className="fixed bottom-6 right-6 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
              </svg>
              Event details copied to clipboard!
            </div>
          )}

          {/* Scroll to top button */}
          {showScrollTop && (
            <button
              onClick={scrollToTop}
              onMouseDown={handleDragStart}
              onTouchStart={handleDragStart}
              className="fixed bg-primary text-onprimary p-3 rounded-full shadow-lg hover:shadow-xl transition-shadow opacity-25 cursor-move"
              style={{
                left: `${scrollButtonPosition.x}px`,
                top: `${scrollButtonPosition.y}px`,
                touchAction: 'none'
              }}
              title="Scroll to top (drag to reposition)"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
              </svg>
            </button>
          )}
        </div>
      );
    };

    ReactDOM.render(<EventDiscoveryApp />, document.getElementById('root'));
  </script>
</body>
</html>